name: CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  # 後端測試
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      working-directory: ./backend
      run: go mod download

    - name: Run tests
      working-directory: ./backend
      run: go test -v ./...

    - name: Build backend
      working-directory: ./backend
      run: |
        # 靜態編譯,不依賴系統 GLIBC
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v -o tspl-simulator -ldflags="-s -w" .

    - name: Upload backend artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-binary
        path: backend/tspl-simulator

  # 前端測試和構建
  frontend-test:
    name: Frontend Tests & Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm install

    - name: Run linter
      working-directory: ./frontend
      run: npm run lint || true

    - name: Run tests
      working-directory: ./frontend
      run: npm test -- --watchAll=false || true

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Upload frontend artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/build/

  # 部署到 Ubuntu 主機
  deploy:
    name: Deploy to Ubuntu Server
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-binary
        path: ./backend

    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: ./frontend/build

    - name: Deploy to Ubuntu Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: "backend/tspl-simulator,frontend/build/*,backend/.env.example,deploy/tspl-simulator.service,deploy/diagnose.sh,deploy/ssl-diagnose.sh,deploy/fix-nginx.sh,deploy/fix-ssl-chain.sh,deploy/setup-cloudflare-origin-pull.sh"
        target: "/opt/tspl-simulator"
        strip_components: 0

    - name: Execute deployment script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          cd /opt/tspl-simulator
          chmod +x backend/tspl-simulator

          # 創建 data 目錄
          mkdir -p backend/data/API_print backend/data/MQTT_print

          # 停止舊服務
          sudo systemctl stop tspl-simulator || true

          # 複製環境變數（如果不存在）
          if [ ! -f backend/.env ]; then
            cp backend/.env.example backend/.env
          fi

          # 安裝 systemd 服務文件
          sudo cp deploy/tspl-simulator.service /etc/systemd/system/

          # 設置腳本權限
          chmod +x deploy/diagnose.sh deploy/ssl-diagnose.sh deploy/fix-nginx.sh deploy/fix-ssl-chain.sh deploy/setup-cloudflare-origin-pull.sh

          # 修復 Nginx 配置
          sudo ./deploy/fix-nginx.sh

          # 修復 SSL 證書鏈 (支持 Full strict 模式)
          if [ -f /etc/ssl/cloudflare/cert.pem ] && [ -f /etc/ssl/cloudflare/key.pem ]; then
            sudo ./deploy/fix-ssl-chain.sh || echo "SSL chain fix failed, continuing..."
          fi

          # 啟動新服務
          sudo systemctl daemon-reload
          sudo systemctl start tspl-simulator
          sudo systemctl enable tspl-simulator

          # 等待服務啟動
          sleep 3

          # 檢查服務狀態
          echo "=== 服務狀態 ==="
          sudo systemctl status tspl-simulator --no-pager || true

          # 顯示最近日誌以便調試
          echo "=== 服務日誌 (最近 50 行) ==="
          sudo journalctl -u tspl-simulator -n 50 --no-pager

          # 測試後端 API
          echo "=== API 健康檢查 ==="
          curl -f http://127.0.0.1:8080/api/health || echo "後端 API 無法連接"

          # 檢查端口監聽
          echo "=== 端口監聽狀態 ==="
          sudo netstat -tlnp | grep 8080 || echo "端口 8080 未監聽"

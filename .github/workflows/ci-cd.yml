name: CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  # 後端測試
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      working-directory: ./backend
      run: go mod download

    - name: Run tests
      working-directory: ./backend
      run: go test -v ./...

    - name: Build backend
      working-directory: ./backend
      run: go build -v -o tspl-simulator .

    - name: Upload backend artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-binary
        path: backend/tspl-simulator

  # 前端測試和構建
  frontend-test:
    name: Frontend Tests & Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run linter
      working-directory: ./frontend
      run: npm run lint || true

    - name: Run tests
      working-directory: ./frontend
      run: npm test -- --watchAll=false || true

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Upload frontend artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/build/

  # 部署到 Ubuntu 主機
  deploy:
    name: Deploy to Ubuntu Server
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-binary
        path: ./backend

    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: ./frontend/build

    - name: Deploy to Ubuntu Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: "backend/tspl-simulator,frontend/build/*,backend/.env.example"
        target: "/opt/tspl-simulator"
        strip_components: 0

    - name: Execute deployment script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          cd /opt/tspl-simulator
          chmod +x backend/tspl-simulator

          # 創建 data 目錄
          mkdir -p backend/data/API_print backend/data/MQTT_print

          # 停止舊服務
          sudo systemctl stop tspl-simulator || true

          # 複製環境變數（如果不存在）
          if [ ! -f backend/.env ]; then
            cp backend/.env.example backend/.env
          fi

          # 啟動新服務
          sudo systemctl daemon-reload
          sudo systemctl start tspl-simulator
          sudo systemctl enable tspl-simulator

          # 檢查服務狀態
          sudo systemctl status tspl-simulator
